#!/usr/bin/env bash

SLEEP=${SLEEP-2}
ABFLAGS=${ABFLAGS-"-n 2000 -c 50"}
ADDR=${ADDR-http://127.0.0.1:3000/}
AB=${AB-ab}

log(){
  echo "... $@"
}

bm(){
  local type=$1
  local file=$2
  log benchmarking $type $file
  case $type in
    node|express)
      node benchmarks/$type/$file &
      ;;
    thin)
      thin -R benchmarks/thin/$file -p 3000 start &
      ;;
  esac
  pid=$!
  sleep $SLEEP
  $AB $ABFLAGS -e benchmarks/$type/$file.csv $ADDR > benchmarks/$type/$file.out
  log $(cat benchmarks/$type/$file.out | grep Requests)
  kill -KILL $pid
}

log ab $ABFLAGS $ADDR
bm node simple.js
bm node static.js
bm node static.large.js
bm express simple.js
bm express static.js
bm express static.large.js
bm thin simple.ru
bm thin simple.sinatra.ru
bm thin static.sinatra.ru
bm thin static.sinatra.large.ru